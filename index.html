<!DOCTYPE html>
<html>
<head>
  <title>Mapa da CEASA</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS do Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    #map {
      height: 100vh;
      width: 100%;
    }

    /* Caixa de busca */
    #searchBox {
      position: absolute;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: white;
      padding: 5px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      width: 300px;
    }

    #searchInput {
      width: 95%;
      padding: 5px;
      border: none;
      border-radius: 6px;
      font-size: 24px;
    }

    #suggestions {
      max-height: 400px;
      overflow-y: auto;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-top: 2px;
      display: none;
      font-size: 20px;
      font-family: Arial, sans-serif;
    }

    #suggestions div {
      padding: 5px;
      cursor: pointer;
    }

    #suggestions div:hover {
      background: #eee;
    }

    .rotulo-mapa {
      border: none;
      background: transparent;
      border-radius: 50px;
      font-weight: bold;
      font-size: 14px;
      padding: 10px;
      text-align: center;
      color: green;
      text-shadow: 1px 1px 2px #fff; /* contraste */
    }
  </style>

</head>
<body>

  <!-- Caixa de busca -->
  <div id="searchBox">
    <input type="text" id="searchInput" placeholder="Buscar empresa...">
    <div id="suggestions"></div>
  </div>

  <div id="map"></div>

  <!-- JS do Leaflet -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // Inicializa mapa (CEASA-ES como centro inicial)
    var map = L.map('map').setView([-20.340995, -40.402908], 18);

    // Camada do OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Lista de pavilh√µes
    var pavilhoes = [
       {nome: "PP1", coords: [-20.34209272807713, -40.40343056150704]},
       {nome: "PNP1", coords: [-20.341443874819706, -40.402886073084716]},
       {nome: "PNP2", coords: [-20.341690338777376, -40.404133300258756]},
       {nome: "PP2", coords: [-20.340988669934653, -40.40317306944145]},
       {nome: "CC2", coords: [-20.342462422314554, -40.403020183530906]},
       {nome: "CC1", coords: [-20.3420210525558, -40.400851617544426]},
       {nome: "PP3", coords: [-20.340411488332943, -40.402987997023466]},
       {nome: "MSV", coords: [-20.339999034810244, -40.40271441170787]},
       {nome: "PPA", coords: [-20.340904419135413, -40.40136257838305]},
       {nome: "Caixaria", coords: [-20.339375322501912, -40.40288607308167]}
    ];

    // Adiciona os nomes dos pavilh√µes diretamente no mapa
    pavilhoes.forEach(function(p) {
      L.tooltip({
        permanent: true,
        direction: 'center',
        className: 'rotulo-mapa'
      })
      .setLatLng(p.coords)
      .setContent(p.nome)
      .addTo(map);
    });

    // Lista de empresas
    var empresas = [
      {nome: "Sicoob", coords: [-20.341189, -40.402039]},
      {nome: "Portaria 01", coords: [-20.342153, -40.401561]},
      {nome: "Portaria 02", coords: [-20.339382, -40.402143]},
      {nome: "Cheid - Bar e Lanchonete", coords: [-20.341577, -40.404226]},
      {nome: "Extrafruti", coords: [-20.342007, -40.402896]},
      {nome: "Shopping Rural", coords: [-20.342553279509563, -40.40342035030273]},
      {nome: "Aupeces", coords: [-20.341834, -40.401945]},
      {nome: "Banco do Brasil", coords: [-20.342282925119797, -40.40192770097774]},
      {nome: "Banestes", coords: [-20.342342025885813, -40.4021530065293]},
      {nome: "Administra√ß√£o <br> CEASA", coords: [-20.34167776410467, -40.40203044842133]}
    ];

    // Cria marcadores mas n√£o adiciona ao mapa
    var markers = {};
    empresas.forEach(function(e) {
      var marker = L.marker(e.coords)
        .bindPopup("<b>" + e.nome + "</b>")
        .bindTooltip(e.nome, {permanent: false, direction: "top"});
      markers[e.nome] = marker;
    });

    // Fun√ß√£o de busca
    var searchInput = document.getElementById("searchInput");
    var suggestions = document.getElementById("suggestions");

    searchInput.addEventListener("input", function() {
      var query = this.value.toLowerCase();
      suggestions.innerHTML = "";

      // Remove todos os marcadores do mapa
      Object.values(markers).forEach(marker => {
        if (map.hasLayer(marker)) map.removeLayer(marker);
      });

      if (query.length > 0) {
        var matches = empresas.filter(e => e.nome.toLowerCase().includes(query));
        if (matches.length > 0) {
          suggestions.style.display = "block";
          matches.forEach(function(e) {
            var div = document.createElement("div");
            div.textContent = e.nome;
            div.onclick = function() {
              searchInput.value = e.nome;
              suggestions.style.display = "none";

              var marker = markers[e.nome];
              // Adiciona marcador ao mapa se ainda n√£o estiver
              if (!map.hasLayer(marker)) map.addLayer(marker);

              map.setView(marker.getLatLng(), 19);
              marker.openPopup();
            };
            suggestions.appendChild(div);
          });
        } else {
          suggestions.style.display = "none";
        }
      } else {
        suggestions.style.display = "none";
      }
    });

    // =====================================
    // Localiza√ß√£o em tempo real
    var userMarker;

    // √çcone personalizado vermelho
    var redIcon = new L.Icon({
       iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
       shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
       iconSize: [25, 41],
       iconAnchor: [12, 41],
       popupAnchor: [1, -34],
       shadowSize: [41, 41]
    });

    // Localiza√ß√£o em tempo real, sem centralizar
    map.locate({
      setView: false,
      maxZoom: 18,
      watch: true,
      enableHighAccuracy: true
    });

    map.on("locationfound", function(e) {
      if (!userMarker) {
         userMarker = L.marker(e.latlng, { icon: redIcon }).addTo(map)
          .bindPopup("üìç Voc√™ est√° aqui");
      } else {
        userMarker.setLatLng(e.latlng);
      }
    });

    map.on("locationerror", function() {
      alert("N√£o foi poss√≠vel acessar sua localiza√ß√£o.");
    });

  </script>
</body>
</html>
