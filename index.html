<!DOCTYPE html>
<html>
<head>
  <title>Mapa da CEASA</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS do Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <!-- Manifest PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">

  <style>
    #map { height: 100vh; width: 100%; }

    /* Caixa de busca */
    #searchBox {
      position: absolute;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: white;
      padding: 5px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      width: 300px;
    }
    #searchInput {
      width: 95%;
      padding: 5px;
      border: none;
      border-radius: 6px;
      font-size: 24px;
    }
    #suggestions {
      max-height: 400px;
      overflow-y: auto;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-top: 2px;
      display: none;
      font-size: 20px;
      font-family: Arial, sans-serif;
    }
    #suggestions div { padding: 5px; cursor: pointer; }
    #suggestions div:hover { background: #eee; }

    .rotulo-mapa {
      border: none;
      background: white;
      border-radius: 5px;
      font-weight: bold;
      font-size: 14px;
      padding: 5px;
      text-align: center;
      color: green;
      text-shadow: 1px 1px 2px #fff;
    }

    #routeInfo {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-size: 18px;
      display: none;
    }

    /* Bot√£o moderno de instala√ß√£o PWA */
    #installBtn {
      display: none; /* s√≥ aparece quando beforeinstallprompt √© capturado */
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 2000;
      background: linear-gradient(135deg, #4CAF50, #2E7D32);
      color: white;
      border: none;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    #installBtn:hover {
      transform: scale(1.15);
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }

    #installBtn:active {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <!-- Caixa de busca -->
  <div id="searchBox">
    <input type="text" id="searchInput" placeholder="Buscar empresas ou locais">
    <div id="suggestions"></div>
  </div>

  <!-- Informa√ß√µes da rota -->
  <div id="routeInfo"></div>

  <!-- Mapa -->
  <div id="map"></div>

  <!-- Bot√£o moderno de instala√ß√£o -->
  <button id="installBtn" title="Instalar aplicativo">üì≤</button>

  <!-- JS do Leaflet -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

  <script>
    // ---------- MAPA ----------
    var map = L.map('map').setView([-20.340995, -40.402908], 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Lista resumida de pavilh√µes
    var pavilhoes = [
      {nome: "PP1", coords: [-20.34209272807713, -40.40343056150704]},
      {nome: "PNP1", coords: [-20.341443874819706, -40.402886073084716]},
      {nome: "PNP2", coords: [-20.341690338777376, -40.404133300258756]},
      {nome: "PP2", coords: [-20.340988669934653, -40.40317306944145]}
    ];

    pavilhoes.forEach(function(p) {
      L.tooltip({
        permanent: true,
        direction: 'center',
        className: 'rotulo-mapa'
      })
      .setLatLng(p.coords)
      .setContent(p.nome)
      .addTo(map);
    });

    // Empresas de exemplo
    var empresas = [
      {nome: "Sicoob", coords: [-20.341189, -40.402039]},
      {nome: "Portaria 01", coords: [-20.342153, -40.401561]},
      {nome: "Portaria 02", coords: [-20.339382, -40.402143]}
    ];

    var markers = {};
    empresas.forEach(function(e) {
      var marker = L.marker(e.coords)
        .bindPopup("<b>" + e.nome + "</b>")
        .bindTooltip(e.nome, {permanent: false, direction: "top"});
      markers[e.nome] = marker;
    });

    var searchInput = document.getElementById("searchInput");
    var suggestions = document.getElementById("suggestions");
    var routeInfo = document.getElementById("routeInfo");
    var routingControl;
    var userMarker;

    var redIcon = new L.Icon({
       iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
       shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
       iconSize: [25, 41],
       iconAnchor: [12, 41],
       popupAnchor: [1, -34],
       shadowSize: [41, 41]
    });

    map.locate({ setView: false, maxZoom: 18, watch: true, enableHighAccuracy: true });
    map.on("locationfound", function(e) {
      if (!userMarker) {
         userMarker = L.marker(e.latlng, { icon: redIcon }).addTo(map)
          .bindPopup("üìç Voc√™ est√° aqui");
      } else {
        userMarker.setLatLng(e.latlng);
      }
    });
    map.on("locationerror", function() {
      alert("N√£o foi poss√≠vel acessar sua localiza√ß√£o.");
    });

    searchInput.addEventListener("input", function() {
      var query = this.value.toLowerCase();
      suggestions.innerHTML = "";
      Object.values(markers).forEach(marker => { if (map.hasLayer(marker)) map.removeLayer(marker); });

      if (query.length > 0) {
        var matches = empresas.filter(e => e.nome.toLowerCase().includes(query));
        if (matches.length > 0) {
          suggestions.style.display = "block";
          matches.forEach(function(e) {
            var div = document.createElement("div");
            div.textContent = e.nome;
            div.onclick = function() {
              searchInput.value = e.nome;
              suggestions.style.display = "none";

              var marker = markers[e.nome];
              if (!map.hasLayer(marker)) map.addLayer(marker);
              map.setView(marker.getLatLng(), 19);
              marker.openPopup();

              if (routingControl) map.removeControl(routingControl);

              if (userMarker) {
                routingControl = L.Routing.control({
                  waypoints: [userMarker.getLatLng(), marker.getLatLng()],
                  router: L.Routing.osrmv1({ profile: 'foot' }),
                  lineOptions: { styles: [{ color: 'blue', weight: 5 }] },
                  addWaypoints: false,
                  draggableWaypoints: false,
                  show: false,
                  routeWhileDragging: false,
                  createMarker: function() { return null; }
                }).on('routesfound', function(e) {
                  var route = e.routes[0];
                  var km = (route.summary.totalDistance / 1000).toFixed(2);
                  var min = Math.round(route.summary.totalTime / 60);
                  routeInfo.innerHTML = "Dist√¢ncia: " + km + " km | Tempo estimado: " + min + " min";
                  routeInfo.style.display = "block";
                }).addTo(map);
              } else { alert("Sua localiza√ß√£o ainda n√£o foi encontrada!"); }
            };
            suggestions.appendChild(div);
          });
        } else { suggestions.style.display = "none"; }
      } else { suggestions.style.display = "none"; }
    });

    // ---------- SERVICE WORKER (PWA) ----------
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(() => console.log("‚úÖ Service Worker registrado!"))
        .catch(err => console.log("‚ùå Erro no Service Worker:", err));
    }

    // ---------- BOT√ÉO MODERNO DE INSTALA√á√ÉO PWA ----------
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'flex'; // mostra bot√£o quando o evento ocorrer
    });

    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt(); // mostra o prompt nativo
      const { outcome } = await deferredPrompt.userChoice;
      console.log(outcome === 'accepted' ? 'Usu√°rio aceitou!' : 'Usu√°rio rejeitou!');
      deferredPrompt = null;
      installBtn.style.display = 'none'; // esconde bot√£o ap√≥s instala√ß√£o
    });
  </script>
</body>
</html>
